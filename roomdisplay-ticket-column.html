<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iris-polymer-ticketlist/iris-ticketlist.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<dom-module id="roomdisplay-ticket-column">
  <template>
    <style>
      :host {
        display: block;
      }

      iron-icon {
        color: white;
        background-color: var(--mydoc-brown-400);
        border-radius: 50%;
        height: 40px;
        width: 40px;
        margin-right: 10px;
      }

      .roomdisplay-column-head,
      .display-row {
        font-size: 32px;
      }

      .display-row {}

      table {
        @apply(--roomdisplay-column-table);
      }

      #subcaption th {
        @apply(--roomdisplay-column-subcaption);
      }

      th,
      td {
        text-align: center;
        @apply(--roomdisplay-column-cell);
      }

      th {
        @apply(--roomdisplay-column-header-cell);
      }

      tr:nth-child(2n+1) {
        @apply(--roomdisplay-odd-row);
      }
      
      tr:nth-child(2n) {
        @apply(--roomdisplay-even-row);
      }

      td span {
        border-bottom: 2px solid var(--mydoc-red-400);
        margin: 0 auto;
        width: var(--iris-ticket-column-width, 150px);
        display: table-cell;
        vertical-align: bottom;
        @apply(--roomdisplay-column-inner-cell);
      }

      .ticket-label {
        @apply(--iris-ticket-column-ticket-label);
        color: var(--iris-ticket-column-ticket-color, --default-primary-color);
      }

      .operator-label {
        @apply(--iris-ticket-column-operator-label);
        color: var(--iris-ticket-column-operator-color, --default-primary-color);
      }
    </style>


    <template is="dom-repeat" items="[[splitByColumns(content)]]" as="ticket_col">
      <table class="roomdisplay-column-head">
        <template is="dom-if" if="[[showHeader]]">
          <tr>
            <th>
              <iron-icon hidden$="[[!hasIcon]]" icon="expand-more"></iron-icon>Клиент
            </th>
            <th>
              <iron-icon hidden$="[[!hasIcon]]" icon="expand-more"></iron-icon>Окно
            </th>
          </tr>
        </template>

        <template is="dom-if" if="[[subcaption]]">
          <tr id="subcaption">
            <th colspan="2">
              [[subcaption]]
            </th>
          </tr>
        </template>

        <template is="dom-repeat" items="[[ticket_col]]">
          <tr class="display-row">
            <td class="ticket-label"><span>[[item.label]]</span></td>
            <td class="operator-label"><span>[[item.workstation.short_label]]</span></td>
          </tr>
        </template>

      </table>
    </template>

  </template>
  <script>
    'use strict'
    Polymer({
      is: 'roomdisplay-ticket-column',

      behaviors: [
        Polymer.IronResizableBehavior
      ],
      properties: {
        tickets: {
          type: Array,
          value: []
        },
        colsCount: {
          type: Number,
          value: 2,
          reflectToAttribute: true
        },
        rowsCount: {
          type: String,
          value: 'auto',
          reflectToAttribute: true
        },
        content: {
          type: Array,
          computed: 'computeContent(colsCount, computedRows,tickets)'
        },
        filter: {
          type: Object
        },
        showHeader: {
          type: Boolean,
          value: false
        },
        hasIcon: {
          type: Boolean,
          value: false
        },
        subcaption: String
      },
      listeners: {
        'iron-resize': 'calcRowsCount'
      },
      applyFilter(ticket) {
        let field = this.filter.field;
        let value = this.filter.value;
        return _.get(ticket, field) == value;
      },
      calcRowsCount() {
        if (this.rowsCount !== 'auto') return this.set("computedRows", this.rowsCount);
        let rows = _.floor((this.offsetHeight - 100) / 70);
        this.set("computedRows", rows);
      },
      splitByColumns(tickets) {
        let rows = this.rowsCount == "auto" ? this.computedRows : this.rowsCount;

        return _.chunk(tickets, rows);
      },
      computeContent(colsCount, computedRows, tickets) {
        this.calcRowsCount();
        let rows = this.computedRows;

        let total = this.colsCount * rows;
        let filtered = _.isEmpty(this.filter) ? tickets : _.filter(tickets, ticket => this.applyFilter(ticket));

        if (!filtered || filtered.length >= total) return _.slice(filtered, 0, total);

        let count = total - filtered.length;
        let empty = _.fill(Array(count), {});

        return _.concat(filtered, empty);
      },
      ready() {
        this.row_model = [{
          label: "Клиент",
          field: 'label'
        }, {
          label: 'Окно',
          field: ['destination'],
          transform: function(ticket) {
            let dest = ticket.destination;

            return dest.label;
          }
        }];
      }
    });
  </script>
</dom-module>
