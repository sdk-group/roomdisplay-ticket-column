<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iris-polymer-ticketlist/iris-ticketlist.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<dom-module id="roomdisplay-ticket-column">
  <template>
    <style>
      :host {
        display: block;
      }
      
      iron-icon {
        color: white;
        background-color: var(--mydoc-brown-400);
        border-radius: 50%;
        height: 40px;
        width: 40px;
        margin-right: 10px;
      }
      
      .roomdisplay-column-head,
      .display-row {
        font-size: 32px;
      }
      
      .display-row {
        height: 70px;
      }
      
      table {
        display: inline-block;
        width: 48%;
      }
      
      th,
      td {
        text-align: center;
        padding-left: 20px;
        padding-right: 20px;
      }
      
      th {
        padding: 10px 20px;
      }
      
      td span {
        border-bottom: 2px solid var(--mydoc-red-400);
        margin: 0 auto;
        width: var(--iris-ticket-column-width, 150px);
        height: var(--iris-ticket-column-height, 57px);
        display: table-cell;
        vertical-align: bottom;
      }
      
      .ticket-label {
        @apply(--iris-ticket-column-ticket-label);
        color: var(--iris-ticket-column-ticket-color, --default-primary-color);
      }
      
      .operator-label {
        @apply(--iris-ticket-column-operator-label);
        color: var(--iris-ticket-column-operator-color, --default-primary-color);
      }
    </style>


    <template is="dom-repeat" items="[[splitByColumns(content)]]" as="ticket_col">
      <table class="roomdisplay-column-head">
        <tr>
          <th>
            <iron-icon icon="expand-more"></iron-icon>Клиент
          </th>
          <th>
            <iron-icon icon="expand-more"></iron-icon>Окно
          </th>
        </tr>

        <template is="dom-repeat" items="[[ticket_col]]">
          <tr class="display-row">
            <td class="ticket-label"><span>[[item.label]]</span></td>
            <td class="operator-label"><span>[[item.workstation.short_label]]</span></td>
          </tr>
        </template>

      </table>
    </template>

  </template>
  <script>
    'use strict'
    Polymer({
      is: 'roomdisplay-ticket-column',

      behaviors: [
        Polymer.IronResizableBehavior
      ],
      properties: {
        tickets: {
          type: Array,
          value: []
        },
        colsCount: {
          type: Number,
          value: 2,
          reflectToAttribute: true
        },
        rowsCount: {
          type: String,
          value: 'auto',
          reflectToAttribute: true
        },
        content: {
          type: Array,
          computed: 'computeContent(colsCount, computedRows,tickets)'
        }
      },
      listeners: {
        'iron-resize': 'calcRowsCount'
      },
      calcRowsCount() {
        if (this.rowsCount !== 'auto') return this.set("computedRows", this.rowsCount);
        let rows = _.floor((this.offsetHeight - 100) / 70);
        this.set("computedRows", rows);
      },
      splitByColumns(tickets) {
        let rows = this.rowsCount == "auto" ? this.computedRows : this.rowsCount;
        return _.chunk(tickets, rows);
      },
      computeContent(colsCount, computedRows, tickets) {
        this.calcRowsCount();
        let rows = this.computedRows;

        let total = this.colsCount * rows;
        if (!this.tickets || this.tickets.length >= total)
          return _.slice(tickets, 0, total);
        let count = total - this.tickets.length;
        let empty = _.fill(Array(count), {});

        return _.concat(tickets, empty);
      },
      ready() {
        this.row_model = [{
          label: "Клиент",
          field: 'label'
        }, {
          label: 'Окно',
          field: ['destination'],
          transform: function(ticket) {
            let dest = ticket.destination;

            return dest.label;
          }
        }];
      }
    });
  </script>
</dom-module>